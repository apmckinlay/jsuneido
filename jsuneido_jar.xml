<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project default="build" name="Make runnable jSuneido JAR">

	<!--                      -->
	<!-- REUSEABLE REFERENCES -->
	<!--                      -->

	<property name="lib.dir" value="lib"/>

	<property name="main.srcdir" value="src/main/java"/>
	<property name="main.destdir" value="target/classes"/>

	<path id="main.classpath">
		<pathelement location="${lib.dir}/asm-all-4.2.jar"/>
		<pathelement location="${lib.dir}/guava-16.0.jar"/>
		<pathelement location="${lib.dir}/jsr305-1.3.9.jar"/>
		<pathelement location="${lib.dir}/lucene-core-3.6.2.jar"/>
		<pathelement location="${lib.dir}/trove-3.0.3.jar"/>
	</path>

	<!--         -->
	<!-- TARGETS -->
	<!--         -->

	<target name="build" depends="create_raw_jar"
			description="Create ProGuard-ed release JAR"
	>
		<exec executable="java" failonerror="true">
			<arg value="-jar"/>
			<arg value="${lib.dir}/proguard.jar"/>
			<arg value="@jsuneido.pro"/>
		</exec>
	</target>

	<target name="rebuild" depends="clean,create_raw_jar,build"/>

	<target name="create_raw_jar" depends="compile"
			description="Create raw JAR"
	>
		<jar destfile="jsuneido-raw.jar" filesetmanifest="mergewithoutmain">
			<manifest>
				<attribute name="Main-Class" value="suneido.Suneido"/>
				<attribute name="Class-Path" value="lucene-core-3.6.2.jar"/>
			</manifest>
			<fileset dir="${main.destdir}">
				<!--  Exclude JSDI tools. These are used for automatic
				      generation of JSDI C++ code and should not be included in
				      the JSuneido runtime. -->
				<exclude name="**/jsdi/tools/**"/>
			</fileset>
		</jar>
	</target>

	<target name="when_built">
		<tstamp>
			<format property="WHEN" pattern="MMM d yyyy HH:mm:ss" locale="ENGLISH, CANADA"/>
		</tstamp>
		<echo file="${main.srcdir}/suneido/WhenBuilt.java">
			// do not edit - generated by jsuneido_jar.xml
			package suneido;
			public class WhenBuilt {
				public static String when() {
					return "${WHEN} (Java)";
				}
			}
		</echo>
	</target>

	<target name="compile" depends="when_built"
			description="Compile main source files"
	>
		<mkdir dir="${main.destdir}"/>
		<javac srcdir="${main.srcdir}" destdir="${main.destdir}"
				classpathref="main.classpath"
				includeAntRuntime="false"
				debug="true"
		>
			<!--  Exclude JDBC stuff. Not currently implemented. -->
			<exclude name="**/jdbc/**"/>
		</javac>
	</target>

	<target name="clean" description="Delete generated files">
		<delete dir="${main.destdir}"/>
	</target>
</project>
